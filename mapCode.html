<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- cdn de map -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.0.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.0.1/mapbox-gl.css' rel='stylesheet' />
    <!-- cdn de direction -->
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.0/mapbox-gl-directions.js"></script>
    <link rel="stylesheet"
        href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.0/mapbox-gl-directions.css"
        type="text/css" />
            <!-- cdn de jQuery -->

        <script
        src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
        crossorigin="anonymous"></script>
            <!-- cdn de du diagramme -->

        <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
        }

        #chartLatitud {
            width: 720px !important;
            height: auto !important;
            background-color: #ffffff;
            margin: 10px auto;
        }
        .directions-control.directions-control-instructions {
            display: none;
        }

    </style>
    <title>Document</title>
</head>
<body>

    <div id='map' style='width: 720px; height: 500px; margin: 0 auto;'></div>
    
    <div id="chartLatitud"></div>
    <div class="modal"><!-- Place at bottom of page --></div>
    <script>

        mapboxgl.accessToken = 'pk.eyJ1IjoiemFvdWNoIiwiYSI6ImNrajhkdGFwNTFuZWoyd252dzdhOGpwMjIifQ.eH3zm8ylhSS5d933zJ751Q';
            var map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/streets-v11', // stylesheet location
                center: [-74.5, 40], // starting position [lng, lat]
                zoom: 9 // starting zoom
            });
            // Add zoom and rotation controls to the map.
        map.addControl(new mapboxgl.NavigationControl());
        //les bouttons de controlle sur la map
        map.addControl(
            new MapboxDirections({
                accessToken: mapboxgl.accessToken
            }),
            'top-left'
        );
        //Des variable globales
        const cordsDebut = {lng: "", lat: ""};
        const cordsFin = {lng: "", lat: ""};
        first = true;
        let cordsDebutText = "";
        let cordsFinText = "";
        let typeTranspport = "driving-traffic";//driving, walking, and cycling
        let points = [];
        let distance = 0;
            $('#mapbox-directions-profile-driving-traffic').on('click', function () {
                typeTranspport = "driving-traffic";
                GetLat();
            });
            $('#mapbox-directions-profile-driving').on('click', function () {
                typeTranspport = "driving";
                GetLat();
            });
            $('#mapbox-directions-profile-cycling').on('click', function () {
                typeTranspport = "cycling";
                GetLat();
            });
            $('#mapbox-directions-profile-walking').on('click', function () {
                typeTranspport = "walking";
                GetLat();
            });
        function GetLat() {
            if((cordsFin["lng"] != '' && cordsFin["lat"] != '') && 
                (cordsDebut["lng"] != '' && cordsDebut["lat"] != '') ) {
                    //requete pour recuperer les direction et les lat du trajet
                    $.ajax({
                        url: 'https://api.mapbox.com/directions/v5/mapbox/'+typeTranspport+'/' + cordsDebut["lng"]+','+ cordsDebut["lat"] +
                        ';'+ cordsFin["lng"] + ','+ cordsFin["lat"],
                        type: 'GET',
                        data: {geometries:  "geojson", steps: true, access_token: mapboxgl.accessToken},
                        success: function (response) {
                            let x = [];
                            let y = [];
                            let c = 0;
                            let i = 0;
                            let distanceGlobale =  Math.ceil(response.routes[0].distance);
                            response.routes[0].geometry.coordinates.forEach((coordinate) => {
                                    x[i] = c;
                                    y[i] = coordinate[1];//le vecteur y des lat
                                    c += Math.ceil(response.routes[0].distance/response.routes[0].geometry.coordinates.length)
                                    i++;
                            });
                            //les point du vecteur x sur le diagramme
                            if(x[1] >= 200){
                                for(k = 1; k < i; k++){
                                    x[k] = (x[k]/1000).toFixed(1) + ' km';
                                }
                            } else {
                                for(k = 1; k < i; k++){
                                    x[k] = Math.ceil(x[k]) + ' m';
                                }
                            }
                            //Dessin du diagramme
                            chartElement = '<canvas id="LatitudeChart"><canvas>';
                            $('#chartLatitud').html('');
                            $('#chartLatitud').append(chartElement);
                            var ctx = document.getElementById('LatitudeChart').getContext('2d');
                            var chart = new Chart(ctx, {
                                // The type of chart we want to create
                                type: 'line',
                                // The data for our dataset
                                data: {
                                    labels: x,//le vecter x
                                    datasets: [{
                                        backgroundColor: '#00b2f3',
                                        borderColor: '#00b2f3',
                                        data: y,//le vecteur y
                                    }]
                                },
                                // Configuration options go here
                                options: {
				                    responsive: true,
                                    title: {
                                        display: true,
                                        text: 'Latitude du trajet'
                                    },
                                    tooltips: {
                                        mode: 'index',
                                        intersect: false,
                                    },
                                    hover: {
                                        mode: 'nearest',
                                        intersect: true
                                    },
                                    scales: {
                                        xAxes: [{
                                            display: true,
                                            scaleLabel: {
                                                display: true,
                                                labelString: 'Distqnce'
                                            }
                                        }],
                                        yAxes: [{
                                            display: true,
                                            scaleLabel: {
                                                display: true,
                                                labelString: 'Latitude'
                                            }
                                        }]
                                    }
                                }
                            });
                            
                            console.log(distanceGlobale,x, y, response);
                        },
                        error: function (response) {
                            console.log('[probleme] query directions');
                        }
                    });
                }
        }
        //Click sur la map et recuperation des lng et lat
        map.on('click', function(e) {
            if(first){
                cordsDebut["lng"] = e.lngLat.lng;
                cordsDebut["lat"] = e.lngLat.lat;
                first = false;
                GetLat();
            } else {
                cordsFin["lng"] = e.lngLat.lng;
                cordsFin["lat"] = e.lngLat.lat;

            }
        });
        $('#mapbox-directions-origin-input button').on('click', function(){
            first = true;
        });

        // Lancement aprés le changement de l'inmput de destination 
        $('#mapbox-directions-origin-input input').on('change', function () {
            // Valeur de l'input
            cordsDebutText = $('#mapbox-directions-origin-input input').val();
            
            // Requete http pour recupérer l'atitude et lanfetude de lanplacement de demarage
            $.ajax({
                url:'https://api.mapbox.com/geocoding/v5/mapbox.places/'+cordsDebutText+'.json',
                data: {access_token: mapboxgl.accessToken},
                type: 'GET',
                success : function(response) {
                    cordsDebut["lng"] = response.features[0].geometry.coordinates[0];
                    cordsDebut["lat"] = response.features[0].geometry.coordinates[1];
                },
                error: function(response) {
                    console.log('[probleme] query mapbox.places ');
                }
            });
            //Requperation du trajet et de plusieur point de latitude et de langetude, ainsi que le dessin du graphe
            GetLat();
        });
        //Lancement aprés le changement de l'inmput de destination 
        $('#mapbox-directions-destination-input input').on('change', function () {
            //valeur de l'input
            cordsFinText = $('#mapbox-directions-destination-input input').val();
            //requete http pour recupérer l'atitude et lanfetude de lanplacement de destination
            $.ajax({
                url:'https://api.mapbox.com/geocoding/v5/mapbox.places/'+cordsFinText+'.json',
                data: {access_token: mapboxgl.accessToken},
                type: 'GET',
                success : function(response) {
                    cordsFin["lng"] = response.features[0].geometry.coordinates[0];
                    cordsFin["lat"] = response.features[0].geometry.coordinates[1];
                },
                error: function(response) {
                    console.log('[probleme] query mapbox.places ');
                }
            });
            //Requperation du trajet et de plusieur point de latitude et de langetude, ainsi que le dessin du graphe
            GetLat();
        });
    </script>
</body>
</html>